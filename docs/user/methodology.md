# 监测方法论说明

本文档说明 RelayPulse 的监测原理、数据采集方式、判定标准及局限性，帮助用户正确理解展示数据的性质与适用范围。

## 文档目的与适用范围

RelayPulse 提供对公开可访问网络端点的**自动化技术探测与状态展示**，旨在帮助用户了解服务的可用性与连通性趋势。

**重要声明**：
- 本项目不对任何服务的合规性、合法性、资质或商业信誉作出结论
- 展示结果仅反映特定时间、特定探测方式与特定网络环境下的技术观测
- 数据仅供参考，不构成投资建议或官方认定

---

## 核心概念定义

| 概念 | 说明 |
|-----|------|
| **监测对象（Target）** | 被探测的域名、URL、IP 或公开接口 |
| **采样（Sample）** | 一次探测任务的单次执行结果（含时间戳与结果字段） |
| **监测周期（Check Interval）** | 对同一监测对象发起探测的计划间隔 |
| **窗口期（Window）** | 用于聚合/判定状态的一段时间范围，例如最近 N 次采样或最近 T 分钟 |
| **状态（Status）** | RelayPulse 对采样与窗口聚合后的展示结果 |

### 状态定义

| 状态 | 颜色 | 含义 |
|-----|------|------|
| 成功 | 🟢 绿色 | HTTP 2xx 且响应时间正常 |
| 降级 | 🟡 黄色 | HTTP 2xx 但响应时间超过阈值 |
| 失败 | 🔴 红色 | 连接失败、超时、非 2xx 响应等 |
| 未知 | ⚪ 灰色 | 无数据或采样不足 |

---

## 数据来源与采集方式

RelayPulse 通过自动化方式对目标执行网络连通性与协议层探测，包括：

1. **DNS 解析** - 验证域名可解析
2. **TCP 连接** - 验证端口可达
3. **TLS 握手** - 验证证书有效性
4. **HTTP 请求与响应校验** - 验证接口可用性

### 说明

- 探测仅针对**公开可访问的网络端点**
- 如需调用第三方 API（如 LLM 服务），由服务商或用户自行配置相关 API Key
- API Key 由服务商/用户主动提供，并遵守对应平台条款
- 探测请求遵循服务商的标准 API 格式

---

## 监测频率与采样策略

### 监测周期

- 默认监测周期为配置文件中的 `interval` 设置
- 赞助服务商可享受更高的监测频率

### 采样策略

- 探测时间可能加入少量随机抖动（jitter），避免固定整点产生尖峰流量
- 当出现可恢复的瞬时错误时，系统可能执行有限次数的重试
- 由于队列调度、系统负载与网络条件差异，实际执行时间可能与计划时间存在偏差

---

## 失败判定标准

RelayPulse 将一次采样标记为"失败"，通常满足下列条件之一：

| 失败类型 | SubStatus | 触发条件 |
|---------|-----------|---------|
| DNS 失败 | `network_error` | DNS 解析失败或返回不可用结果 |
| 连接失败 | `network_error` | TCP 连接失败或超时 |
| TLS 失败 | `network_error` | TLS 握手失败（证书错误、协议不兼容等） |
| HTTP 超时 | `network_error` | 请求在超时时间内未完成 |
| 服务器错误 | `server_error` | HTTP 5xx 响应 |
| 限流 | `rate_limit` | HTTP 429 响应 |
| 认证失败 | `auth_error` | HTTP 401/403 响应 |
| 请求错误 | `invalid_request` | HTTP 400 响应 |
| 客户端错误 | `client_error` | 其他 HTTP 4xx 响应 |
| 内容校验失败 | `content_mismatch` | HTTP 2xx 但响应体不含预期内容 |

> **注意**：限流（HTTP 429）在当前实现中被视为**不可用**（红色状态），计入失败统计。这是因为限流通常表示服务对当前用户/IP 暂时不可用。

### 降级判定

- 当 HTTP 2xx 但响应延迟超过配置的 `slow_latency` 阈值时，标记为"降级"（黄色）

---

## 状态聚合与展示逻辑

### 可用率计算

采用**加权平均法**：
- 🟢 绿色（成功）→ 100% 权重
- 🟡 黄色（降级）→ `degraded_weight` 权重（默认 70%）
- 🔴 红色（失败）→ 0% 权重

```
时间块可用率 = (累积权重 / 总探测次数) × 100
总可用率 = 平均(所有时间块的可用率)
```

### 延迟统计

- 仅统计**成功和降级状态**的记录
- 红色（失败）状态不计入延迟统计

### 数据延迟

- 展示的"当前状态"是对最近一段时间内采样结果的聚合
- 部分页面可能存在缓存或异步更新机制，展示可能相对采样产生延迟
- 建议结合"最近一次成功时间""最近错误类型""历史趋势"进行综合判断

---

## 误差与局限性

自动化监测不可避免存在误差，常见原因包括但不限于：

| 误差来源 | 说明 |
|---------|------|
| **网络波动** | 探测点网络质量、路由变化、跨境链路波动 |
| **地域差异** | 不同地区的网络环境和服务可用性可能不同 |
| **CDN/WAF** | 服务商的 CDN/WAF/限流策略可能影响探测流量 |
| **维护窗口** | 服务维护期间可能导致临时不可用 |
| **灰度发布** | 区域性故障或灰度发布导致的局部不可达 |
| **特殊处理** | 目标对非浏览器请求的特殊处理（如需要 JS、验证码） |

### 重要提示

RelayPulse 的结果应被视为**"技术观测信号"**，而非对服务质量、合规性或责任归属的最终结论。

用户不应将 RelayPulse 的结果作为唯一依据作出法律、合规或商业决策；如需严肃用途，建议结合官方公告、合同条款与多来源证据进行核验。

---

## 纠错与下架机制

若你认为 RelayPulse 展示的内容存在错误、过时或不适当之处，可通过 GitHub Issue 提交：

| 场景 | 使用模板 |
|-----|---------|
| 数据错误、状态误判、标记不准确 | [数据纠错/申诉](https://github.com/prehisle/relay-pulse/issues/new?template=3-data-correction.yml) |
| 请求隐藏或停止展示特定条目 | [服务商下架申请](https://github.com/prehisle/relay-pulse/issues/new?template=4-delist-request.yml) |

### 处理目标

- 我们的目标是在 **48 小时内**响应（确认受理、请求补充材料或给出初步结论）
- 节假日或高峰期可能延迟
- 在合理时间内完成核查与处理

---

## 变更记录

| 日期 | 变更内容 |
|-----|---------|
| 2025-12-23 | 初始版本发布 |
